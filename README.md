# Fandom Wiki API (FastAPI)

Backend для дипломного проекта **Warhammer 40,000 Fandom Wiki**.  
Это REST API, которое отвечает за регистрацию пользователей, аутентификацию и полный CRUD по вики-статьям.

> ⚠️ Проект учебный и некоммерческий. Все права на вселенную Warhammer 40,000 принадлежат **Games Workshop**.

---

## Содержание

- [Что это](#что-это)
- [Технологии](#технологии)
- [Структура проекта](#структура-проекта)
- [Подготовка окружения](#подготовка-окружения)
- [Файл .env](#файл-env)
- [Запуск через Docker (рекомендуется)](#запуск-через-docker-рекомендуется)
- [Запуск локально на Python](#запуск-локально-на-python)
- [Основные сущности и хранение данных](#основные-сущности-и-хранение-данных)
- [Аутентификация](#аутентификация)
- [Основные эндпоинты](#основные-эндпоинты)
  - [Пользователь и профиль](#пользователь-и-профиль)
  - [Статьи (CRUD)](#статьи-crud)
  - [Изображения](#изображения)
  - [Служебные эндпоинты](#служебные-эндпоинты)
- [Служебные скрипты](#служебные-скрипты)
- [Примеры запросов](#примеры-запросов)
- [FAQ / Траблшутинг](#faq--траблшутинг)
- [Лицензия](#лицензия)

---

## Что это

**Fandom Wiki API** — это backend-сервис, который:

- хранит пользователей и статьи во вселенной Warhammer 40,000;
- позволяет регистрироваться и логиниться;
- выдаёт список статей, отдельную статью, статьи конкретного автора;
- позволяет авторизованному пользователю создавать, редактировать и удалять свои статьи;
- работает с изображениями (загрузка файлов и сохранение по URL);
- используется фронтендом из папки `FRONT` как основное REST API.

Данные хранятся в JSON-файлах — это **демо-реализация для диплома**, а не промышленная база данных.

---

## Технологии

- **Python 3.11+**
- **FastAPI** — веб-фреймворк
- **uvicorn** — ASGI-сервер
- **passlib (PBKDF2-SHA256)** — хеширование паролей
- **python-multipart** — загрузка файлов
- **Docker / Docker Compose** — контейнеризация и запуск
- Хранение данных:
  - `data/users.json`
  - `data/articles.json`
  - `data/uploads/` — загруженные изображения

Список зависимостей — в `requirements.txt`.

---

## Структура проекта

Упрощённая структура папки `API`:

```text
API/
├── app/
│   ├── __init__.py          # Инициализация пакета
│   ├── auth.py              # Регистрация, логин, профиль, Basic Auth
│   ├── security.py          # Хеширование паролей (PBKDF2-SHA256 и проверка)
│   └── utils/
│       └── images.py        # Работа с изображениями (загрузка, proxy, из URL)
│
├── data/
│   ├── users.json           # Пользователи
│   ├── articles.json        # Статьи
│   └── uploads/             # Загруженные локальные файлы (картинки)
│
├── tools/
│   ├── migrate_users_hashes.py  # Миграция старых паролей в хеши
│   └── fix_articles_authors.py  # Служебный скрипт для статей / авторов
│
├── seeds.py                 # Сид-данные (демо-наполнение articles/users)
├── main.py                  # Точка входа FastAPI-приложения
├── requirements.txt         # Зависимости Python
├── Dockerfile               # Образ для запуска API
├── docker-compose.yml       # Docker Compose для сервиса API
├── run_api.ps1              # PowerShell-скрипт для быстрого запуска в Docker (Windows)
├── .env                     # Настройки окружения для API
└── README.md                # Этот файл

Папки __pycache__ в репозиторий можно не добавлять.

---

Подготовка окружения


Обязательные инструменты

Для любой схемы запуска нужны:

Git
 — работа с репозиторием

Docker Desktop
 — предпочтительный способ запуска

Любой REST-клиент:

Postman / Insomnia, или

обычный curl в терминале

---

Дополнительно (для запуска без Docker)

Python 3.11+

Любая IDE / редактор:

Visual Studio Code + расширение Python


---



Файл .env

В корне папки API должен лежать .env. Пример:

API_PORT=8000          # Порт, на котором API будет доступно снаружи
BACKUP_DIR=./backups   # Папка для резервных копий users.json и articles.json
# SEED_ON_EMPTY=1      # (опционально) автосоздание демо-данных при пустых файлах


---

API_PORT — внешний порт хоста (в контейнере сервис слушает 8000).

BACKUP_DIR — путь к папке, куда будут складываться резервные копии файлов с данными.

SEED_ON_EMPTY — если установить 1, при запуске API проверит, пустые ли данные, и инициализирует демо-статьи/пользователей.

---

Запуск через Docker (рекомендуется)
1. Клонировать репозиторий

git clone https://github.com/<your-username>/fandom-wiki-api.git
cd fandom-wiki-api

Замените <your-username> на свой логин GitHub.
---

2. Создать .env

Создайте файл .env в корне папки API (см. пример выше).

---

3. Запуск через Docker Compose

В папке API:

docker compose up -d          # старт в фоне
# или
docker compose up -d --build  # старт с пересборкой образа



Полезные команды:

docker compose logs -f        # "хвост" логов
docker compose down           # остановка и удаление контейнера





После успешного запуска:

API: http://localhost:8000

Swagger UI: http://localhost:8000/docs

OpenAPI-схема: http://localhost:8000/openapi.json


---------

Альтернатива: прямой запуск Docker-контейнера

Если не хочется использовать Compose:

docker build -t fandom-wiki-api .
docker run --name fandom-wiki-api \
  -p 8000:8000 \
  -v "${PWD}/data:/app/data" \
  fandom-wiki-api


На Windows PowerShell удобно использовать скрипт run_api.ps1:

.\run_api.ps1

---------

Запуск локально на Python

Если Docker не используется, можно запустить API напрямую.

1. Виртуальное окружение

cd API
python -m venv venv

# Linux / macOS
source venv/bin/activate

# Windows (PowerShell)
# .\venv\Scripts\Activate.ps1


2. Установка зависимостей

pip install -r requirements.txt


3. Файл .env

Создайте .env в корне API (см. раздел Файл .env).

4. Запуск сервера

uvicorn main:app --host 0.0.0.0 --port 8000 --reload

API будет доступно по адресу: http://localhost:8000.

---

Основные сущности и хранение данных

Все данные лежат в папке data/:

data/users.json — пользователи
Словарь вида { "<id>": { ...user fields... } }.

data/articles.json — статьи
Массив объектов статей.

data/uploads/ — загруженные изображения (локальные файлы).

При включённом BACKUP_DIR перед изменением данных создаются резервные копии users.json и articles.json.

---------

Аутентификация

Используется HTTP Basic Auth.

Логин и пароль передаются в заголовке Authorization: Basic <base64(login:password)>.

В users.json хранится только хеш пароля (passwordHash), а не сам пароль.

Хеширование — через PBKDF2-SHA256.

Сценарий:

Пользователь регистрируется через POST /register.

Логинится через POST /login.

Все защищённые эндпоинты вызываются с Basic Auth (логин/пароль).

---------

Основные эндпоинты

Ниже — логическая сводка основных роутов (точные схемы см. в Swagger: /docs).

Пользователь и профиль

POST /register
Регистрация нового пользователя.

POST /login
Авторизация. Возвращает данные пользователя (без пароля).

GET /myProfile (требуется авторизация)
Профиль текущего пользователя.

GET /myArticles (требуется авторизация)
Список статей, созданных текущим пользователем.

PUT /updateUser (требуется авторизация)
Обновление данных учётной записи (имя, email, avatar URL и т.п.).

Статьи (CRUD)

GET /articles
Список статей. Поддерживает:

пагинацию;

поиск по заголовку (title).

GET /articles/{id}
Получить статью по идентификатору.

POST /articles (требуется авторизация)
Создать новую статью. Автором становится текущий пользователь.

PATCH /articles/{id} (требуется авторизация, только автор)
Обновить существующую статью.

DELETE /articles/{id} (только автор)
Удалить статью.
При удалении также чистятся связанные локальные изображения из data/uploads/ (внешние URL не трогаются).

Структура статьи (упрощённо):

{
  "id": 1051,
  "author": "User01",
  "author_id": 6,
  "title": "Заголовок",
  "previewImg": "/uploads/uuid.jpg",
  "mainInfo": {
    "name": "Имя персонажа",
    "image": "/uploads/uuid.jpg",
    "age": 21,
    "gender": "Женский",
    "height": 180,
    "weight": 65
  },
  "mainContent": [
    { "type": "h1", "content": "Вступление" },
    { "type": "p",  "content": "Текст..." },
    { "type": "image", "content": "/uploads/uuid.jpg" },
    {
      "type": "ul",
      "content": [
        { "type": "li", "content": "Пункт 1" },
        { "type": "li", "content": "Пункт 2" }
      ]
    }
  ]
}


Поддерживаемые типы блоков:
"h1" | "h2" | "h3" | "p" | "image" | "ul" | "li".

Изображения

POST /upload-image
Загрузка изображения (формат multipart/form-data, поле file).
Файл сохраняется в data/uploads/, в ответ возвращается путь.

POST /images/fromUrl
Сохранение изображения по внешнему URL. Сервер скачивает файл и кладёт его в uploads.

GET /images/proxy
Прокси-доступ к внешним изображениям: API скачивает картинку и отдаёт клиенту.

GET /uploads/{path}
Раздача локальных загруженных файлов.

Ограничения (см. images.py):

максимальный размер файла: 5 МБ;

поддерживаемые форматы: JPG, JPEG, PNG, WebP, GIF, SVG.

Служебные эндпоинты

GET /health
Простая проверка здоровья сервиса.

GET /export
Экспорт всех данных (пользователи + статьи) в одном ответе.

GET /openapi.json
OpenAPI-схема (генерируется FastAPI автоматически).

---------

Служебные скрипты

В папке tools/:

migrate_users_hashes.py
Если в users.json ещё остались записи со старым полем password (plaintext), скрипт:

создаёт резервную копию data/users.backup.json;

заменяет password → passwordHash с использованием PBKDF2-SHA256.

Запуск:

python tools/migrate_users_hashes.py

fix_articles_authors.py
Служебный скрипт для исправления/миграции авторов статей (например, после изменений структуры данных).

Также есть seeds.py:

Инициализирует демо-данные (пользователи + статьи).
Может вызываться вручную или при старте, если установлен SEED_ON_EMPTY=1.

---------

Примеры запросов

Примеры с использованием curl.




Регистрация

curl -X POST http://localhost:8000/register \
  -H "Content-Type: application/json" \
  -d "{\"name\":\"User\",\"login\":\"user01\",\"password\":\"Pa$$w0rd\",\"email\":\"user@example.com\"}"




Логин

curl -X POST http://localhost:8000/login \
  -H "Content-Type: application/json" \
  -d "{\"login\":\"user01\",\"password\":\"Pa$$w0rd\"}"



Профиль текущего пользователя

curl -u user01:Pa$$w0rd http://localhost:8000/myProfile




Создание статьи

curl -u user01:Pa$$w0rd -X POST http://localhost:8000/articles \
  -H "Content-Type: application/json" \
  -d "{
    \"title\": \"Новая статья\",
    \"mainInfo\": {
      \"name\": \"Имя\",
      \"image\": \"\",
      \"age\": 25,
      \"gender\": \"Мужской\",
      \"height\": 180,
      \"weight\": 75
    },
    \"mainContent\": [
      { \"type\": \"p\", \"content\": \"Привет, Империум!\" }
    ]
  }"


---------

FAQ / Траблшутинг


---------

❓ 401 Unauthorized на /myProfile или POST /articles

Скорее всего, запрос ушёл без Basic Auth.

В curl нужно добавить -u login:password.

В Postman / Insomnia — вкладка Authorization → Basic Auth.



---------

❓ При удалении статьи автоматически удаляются все связанные локальные изображения из data/uploads/.

---------

❓ Папка uploads пустая

Проверь, что при запуске через Docker папка data/ примонтирована как volume:
-v "${PWD}/data:/app/data" или том в docker-compose.yml.

При запуске без Docker убедись, что у процесса есть права на запись в data/uploads/.

Лицензия

Учебный проект, созданный как часть дипломной работы по фронтенд/бекенд-разработке.

Не предназначен для продакшн-нагрузок и хранения реальных персональных данных.

Весь контент вселенной Warhammer 40,000 является собственностью Games Workshop.
Использование названий, изображений и описаний лора носит чисто демонстрационный характер.

«В мрачной тьме далёкого будущего есть только война.»