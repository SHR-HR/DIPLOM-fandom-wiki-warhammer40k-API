# Модуль безопасности для хеширования и верификации паролей
# Использует библиотеку passlib для безопасной работы с паролями

from passlib.context import CryptContext

# Создание контекста для работы с паролями
# Контекст поддерживает несколько алгоритмов хеширования для обратной совместимости
pwd_ctx = CryptContext(
    # Список поддерживаемых схем хеширования в порядке приоритета
    schemes=["pbkdf2_sha256", "bcrypt"],
    
    # Алгоритм по умолчанию для создания новых хешей
    default="pbkdf2_sha256",
    
    # Автоматическое определение устаревших алгоритмов при проверке
    deprecated="auto",
)

def hash_password(password: str) -> str:
    """
    Создание безопасного хеша пароля.
    
    Args:
        password (str): Пароль в открытом виде для хеширования
        
    Returns:
        str: Хеш пароля в формате, включающем алгоритм и параметры
        
    Особенности:
        - Использует алгоритм по умолчанию (pbkdf2_sha256)
        - Автоматически добавляет "соль" (salt) для защиты от rainbow-таблиц
        - Включает параметры алгоритма в результат (количество итераций и т.д.)
        
    Пример результата:
        "pbkdf2_sha256$260000$HxqGYB$..." 
        ^ алгоритм    ^ итерации ^ соль ^ хеш
    """
    return pwd_ctx.hash(password)

def verify_password(password: str, password_hash: str) -> bool:
    """
    Проверка пароля против хеша.
    
    Args:
        password (str): Пароль в открытом виде для проверки
        password_hash (str): Хеш для сравнения (может быть любого поддерживаемого формата)
        
    Returns:
        bool: True если пароль соответствует хешу, False в противном случае
        
    Особенности:
        - Автоматически определяет алгоритм хеширования по формату хеша
        - Поддерживает все схемы из pwd_ctx.schemes
        - Защищена от атак по времени (constant-time comparison)
        
    Примеры поддерживаемых форматов:
        - pbkdf2_sha256: "pbkdf2_sha256$260000$HxqGYB$..."
        - bcrypt: "bcrypt$2b$12$NTNxMjM0NTY3ODkwMDEyM$..."
    """
    return pwd_ctx.verify(password, password_hash)

# Подробное объяснение системы безопасности паролей:

# CryptContext - центральный компонент:

# Настройки контекста:

# pwd_ctx = CryptContext(
#     schemes=["pbkdf2_sha256", "bcrypt"],  # Порядок определяет приоритет
#     default="pbkdf2_sha256",              # Новые хеши создаются этим алгоритмом
#     deprecated="auto",                    # Автоопределение устаревших хешей
# )

# Поддерживаемые алгоритмы:
# PBKDF2-SHA256 (основной):
# Алгоритм: PBKDF2 с SHA256

# Итерации: 260,000 (автоматически настраивается passlib)

# Соль: 16 байт (автоматически генерируется)

# Формат: $pbkdf2-sha256$260000$HxqGYB$...

# Преимущества:

# Защищен от GPU-атак (вычислительно сложный)

# Стандартизирован NIST

# Хорошая производительность на CPU

# Bcrypt (для обратной совместимости):
# Алгоритм: Adaptive hashing based on Blowfish

# Фактор стоимости: 12 (автоматически настраивается)

# Формат: $2b$12$NTNxMjM0NTY3ODkwMDEyM$...

# Преимущества:

# Очень популярен, широко поддерживается

# Автоматическая адаптация к вычислительной мощности

# Функция hash_password:
# Процесс хеширования:
# Принимает пароль в открытом виде

# Генерирует случайную соль автоматически

# Применяет алгоритм PBKDF2-SHA256 с большим количеством итераций

# Возвращает строку содержащую алгоритм, параметры и хеш

# Пример использования:

# # При регистрации пользователя
# password = "my_secure_password"
# hashed = hash_password(password)
# # Результат: "pbkdf2_sha256$260000$HxqGYB$k5g7B2aT2sR8vY1wX9zC4q6E8r0tG3hF7jL9mN1bV3cX5zB8"

# Безопасность:
# Уникальная соль для каждого пароля предотвращает rainbow table атаки

# Большое количество итераций замедляет brute-force атаки

# Стандартные алгоритмы проверенные криптографическим сообществом

# Функция verify_password:
# Процесс проверки:
# Анализирует формат хеша чтобы определить алгоритм

# Извлекает параметры (соль, количество итераций)

# Вычисляет хеш от предоставленного пароля с теми же параметрами

# Сравнивает хеши за постоянное время (защита от timing attacks)

# Пример использования:

# # При входе пользователя
# password_attempt = "user_input_password"
# stored_hash = "pbkdf2_sha256$260000$HxqGYB$k5g7B2aT2sR8vY1wX9zC4q6E8r0tG3hF7jL9mN1bV3cX5zB8"

# if verify_password(password_attempt, stored_hash):
#     print("Пароль верный!")
# else:
#     print("Неверный пароль!")

# Поддержка нескольких форматов:

# # Может проверять хеши разных алгоритмов:
# verify_password("pass", "pbkdf2_sha256$260000$...")  # PBKDF2
# verify_password("pass", "bcrypt$2b$12$...")         # Bcrypt

# Архитектурные преимущества:
# Гибкость миграции:
# Добавление новых алгоритмов без нарушения работы старых хешей

# Постепенный переход на более безопасные алгоритмы

# Обратная совместимость с существующей базой пользователей

# Безопасность по умолчанию:
# Автоматическая настройка параметров безопасности

# Защита от устаревания - deprecated="auto" помечает старые алгоритмы

# Постоянное время сравнения - защита от timing attacks

# Простота использования:
# Всего две функции для всех операций с паролями

# Автоматическое управление солью и параметрами

# Четкие ошибки от библиотеки passlib при проблемах

# Для проекта Warhammer 40,000 вики:
# Требования к безопасности:
# Защита учетных записей пользователей, особенно модераторов и администраторов

# Соответствие современным стандартам безопасности веб-приложений

# Поддержка длительной миграции так как вики может существовать годами

# Будущие улучшения:

# # Можно легко добавить поддержку новых алгоритмов:
# pwd_ctx = CryptContext(
#     schemes=["argon2", "pbkdf2_sha256", "bcrypt"],  # Argon2 как более безопасная альтернатива
#     default="argon2",
#     deprecated="auto",
# )

# Интеграция с системой:
# При регистрации - hash_password() создает безопасный хеш

# При входе - verify_password() проверяет пароль

# При миграции - автоматическая поддержка старых форматов

# Этот модуль обеспечивает профессиональный уровень безопасности для работы с паролями,
# используя проверенные криптографические алгоритмы и следуя лучшим практикам индустрии,
# что критически важно для любого веб-приложения,
# включая фандомную вики по Warhammer 40,000.




